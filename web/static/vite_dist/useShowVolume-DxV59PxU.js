import{H as _}from"./hlsjs-Cx0E5yqS.js";import{l as P,w as g}from"./usePlayerStore-DPy2bvYr.js";import{d as V,i as B,r as m,s as h,U as w,c as C,p as D,b as H,f as L,u as N,o as R,q as M,V as b}from"./vue-Cts3TEHg.js";import{u as F}from"./useOptionalStorage-QBieSuay.js";import{d as O}from"./index-C1bmuaZv.js";function S(t){return Math.min((Math.exp(t/100)-1)/(Math.E-1),1)}const U=["title"],j=V({__name:"AudioPlayer",props:{title:{},volume:{default:55},isMuted:{type:Boolean,default:!1}},emits:["update:duration","update:currentTime","update:progress"],setup(t,{expose:E,emit:A}){const n=t,f=A,e=B("$audio"),u=m(null),o=m(0),i=m(0),{isPlaying:v,current:r,stop:y}=P(),l=m(null);h(w(n,"volume"),a=>{e.value!==null&&(e.value.volume=S(a))}),h(w(n,"isMuted"),a=>{e.value!==null&&(e.value.muted=a)});const c=()=>{e.value!==null&&(e.value.pause(),e.value.src=""),u.value!==null&&(u.value.destroy(),u.value=null),o.value=0,i.value=0,v.value=!1},d=()=>{if(v.value){c(),M(()=>{d()});return}v.value=!0,M(()=>{e.value&&(e.value.onerror=a=>{var s,T;((s=a.target.error)==null?void 0:s.code)===MediaError.MEDIA_ERR_NETWORK&&((T=e.value)!=null&&T.src)&&(console.log("Network interrupted stream. Automatically reconnecting shortly..."),setTimeout(()=>{d()},5e3))},e.value.onended=()=>{c()},e.value.ontimeupdate=()=>{var p,s;const a=((p=e.value)==null?void 0:p.duration)??0;o.value=a!==1/0&&!isNaN(a)?a:0,i.value=((s=e.value)==null?void 0:s.currentTime)??0},e.value.volume=S(n.volume),e.value.muted=n.isMuted,r.value.isHls?_.isSupported()?(u.value=new _,u.value.loadSource(r.value.url),u.value.attachMedia(e.value)):e.value.canPlayType("application/vnd.apple.mpegurl")?e.value.src=r.value.url:console.log("Your browser does not support HLS."):(e.value.src=r.value.url,navigator.userAgent.includes("Firefox")&&(e.value.src+="?refresh="+Date.now())),e.value.load(),e.value.play(),l.value&&l.value.postMessage("played"))})};h(r,a=>{a.url===null?c():d()}),g(o,a=>{f("update:duration",a)},{throttle:500}),g(i,a=>{f("update:currentTime",a)},{throttle:500});const k=C(()=>o.value!==0?+(i.value/o.value*100).toFixed(2):0);g(k,a=>{f("update:progress",a)},{throttle:500});const x=a=>{e.value!==null&&(e.value.currentTime=a/100*o.value)};return D(()=>{"mediaSession"in navigator&&navigator.mediaSession.setActionHandler("pause",()=>{y()}),"BroadcastChannel"in window&&(l.value=new BroadcastChannel("audio_player"),l.value.addEventListener("message",()=>{y()},{passive:!0}))}),b(()=>{l.value&&l.value.close()}),E({play:d,stop:c,setProgress:x}),(a,p)=>N(v)?(R(),H("audio",{key:0,ref_key:"$audio",ref:e,title:a.title},null,8,U)):L("",!0)}}),$=55;function z(){return F("player_volume",$,{listenToStorageChanges:!1})}function G(){return O(()=>{const t=new Audio;return t.volume=.5,t.volume!==1})}export{j as _,G as a,z as u};
