import{r as te}from"./leaflet-DYDK0jU3.js";import{u as se}from"./PanelLayout-D3dh7E8b.js";import{u as B,b as le,d as ne}from"./usePlayerStore-DPy2bvYr.js";import{d as S,i as A,N as H,p as J,s as R,b as p,G as N,f as M,o as f,S as oe,Q as ie,a3 as ae,c as D,j as V,w as T,y as re,h as b,e,t as s,F as ue,L as ce,m as E,J as O,M as de,u,g as h,r as U,z as q,q as me}from"./vue-Cts3TEHg.js";import{l as j}from"./lodash-Bdl6ys83.js";import{_ as C,P as fe,C as pe,n as _e,ah as ve,ai as he}from"./icons-Be1GHOkw.js";import{_ as be}from"./DataTable-ds0DoLPp.js";import{_ as ge}from"./DateRangeDropdown-dJtUGez0.js";import{g as ye}from"./router-B3NsYQ6y.js";import{u as ke}from"./useHasDatatable-DPFcIMM0.js";import{f as Le}from"./formatTime-DvDPwXf4.js";import{u as Fe}from"./useStationDateTimeFormatter-DdJuYN6n.js";import{u as $e}from"./luxon-B7Gxac0H.js";import"./useOptionalStorage-QBieSuay.js";import"./index-C1bmuaZv.js";import"./bootstrap.esm-BZy605kZ.js";import"./lodash-BwctMegf.js";import"./FormMultiCheck-BRaoZhWq.js";import"./FormCheckbox-VeRpO6PO.js";import"./datetime-BTmRqpun.js";var x=te();L.Control.Fullscreen=L.Control.extend({options:{position:"topleft",title:{false:"View Fullscreen",true:"Exit Fullscreen"}},onAdd:function(n){var t=L.DomUtil.create("div","leaflet-control-fullscreen leaflet-bar leaflet-control");return this.link=L.DomUtil.create("a","leaflet-control-fullscreen-button leaflet-bar-part",t),this.link.href="#",this._map=n,this._map.on("fullscreenchange",this._toggleTitle,this),this._toggleTitle(),L.DomEvent.on(this.link,"click",this._click,this),t},_click:function(n){L.DomEvent.stopPropagation(n),L.DomEvent.preventDefault(n),this._map.toggleFullscreen(this.options)},_toggleTitle:function(){this.link.title=this.options.title[this._map.isFullscreen()]}});L.Map.include({isFullscreen:function(){return this._isFullscreen||!1},toggleFullscreen:function(n){var t=this.getContainer();this.isFullscreen()?n&&n.pseudoFullscreen?this._disablePseudoFullscreen(t):document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msExitFullscreen?document.msExitFullscreen():this._disablePseudoFullscreen(t):n&&n.pseudoFullscreen?this._enablePseudoFullscreen(t):t.requestFullscreen?t.requestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT):t.msRequestFullscreen?t.msRequestFullscreen():this._enablePseudoFullscreen(t)},_enablePseudoFullscreen:function(n){L.DomUtil.addClass(n,"leaflet-pseudo-fullscreen"),this._setFullscreen(!0),this.fire("fullscreenchange")},_disablePseudoFullscreen:function(n){L.DomUtil.removeClass(n,"leaflet-pseudo-fullscreen"),this._setFullscreen(!1),this.fire("fullscreenchange")},_setFullscreen:function(n){this._isFullscreen=n;var t=this.getContainer();n?L.DomUtil.addClass(t,"leaflet-fullscreen-on"):L.DomUtil.removeClass(t,"leaflet-fullscreen-on"),this.invalidateSize()},_onFullscreenChange:function(n){var t=document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement;t===this.getContainer()&&!this._isFullscreen?(this._setFullscreen(!0),this.fire("fullscreenchange")):t!==this.getContainer()&&this._isFullscreen&&(this._setFullscreen(!1),this.fire("fullscreenchange"))}});L.Map.mergeOptions({fullscreenControl:!1});L.Map.addInitHook(function(){this.options.fullscreenControl&&(this.fullscreenControl=new L.Control.Fullscreen(this.options.fullscreenControl),this.addControl(this.fullscreenControl));var n;if("onfullscreenchange"in document?n="fullscreenchange":"onmozfullscreenchange"in document?n="mozfullscreenchange":"onwebkitfullscreenchange"in document?n="webkitfullscreenchange":"onmsfullscreenchange"in document&&(n="MSFullscreenChange"),n){var t=L.bind(this._onFullscreenChange,this);this.whenReady(function(){L.DomEvent.on(document,n,t)}),this.on("unload",function(){L.DomEvent.off(document,n,t)})}});L.control.fullscreen=function(n){return new L.Control.Fullscreen(n)};const xe=S({__name:"InnerMap",setup(n){const t=A("$container"),m=H(null);oe("map",m);const{currentTheme:a}=se(),{$gettext:i}=B();return J(()=>{x.Icon.Default.imagePath="/static/img/leaflet/";const r=x.map(t.value);r.setView([40,0],1),r.addControl(new x.Control.Fullscreen({title:{false:i("View Fullscreen"),true:i("Exit Fullscreen")}})),m.value=r;const g=()=>{if(!a.value)return;const y=`https://cartodb-basemaps-{s}.global.ssl.fastly.net/${a.value}_all/{z}/{x}/{y}.png`;x.tileLayer(y,{id:"main",attribution:"Map tiles by Carto, under CC BY 3.0. Data by OpenStreetMap, under ODbL."}).addTo(r)};g(),R(a,()=>{g()})}),(r,g)=>(f(),p("div",{id:"leaflet-container",ref_key:"$container",ref:t},[m.value?N(r.$slots,"default",{key:0,map:m.value}):M("",!0)],512))}}),De=S({__name:"MapPoint",props:{position:{}},setup(n){const t=n,a=ie("map").value,i=x.marker(t.position);i.addTo(a);const r=new x.Popup,g=A("$content");return R(g,y=>{r.setContent(y),i.bindPopup(r)},{immediate:!0}),ae(()=>{i.remove()}),(y,F)=>(f(),p("div",{ref_key:"$content",ref:g},[N(y.$slots,"default")],512))}}),Ce=S({__name:"Map",props:{listeners:{default:()=>[]}},setup(n){const t=n,m=D(()=>j.filter(t.listeners,function(a){return a.location.lat!==null&&a.location.lon!==null}));return(a,i)=>m.value.length<3e3?(f(),V(xe,{key:0},{default:T(()=>[(f(!0),p(ue,null,re(m.value,r=>(f(),V(De,{key:r.hash,position:[r.location.lat,r.location.lon]},{default:T(()=>[b(s(a.$gettext("IP"))+" : "+s(r.ip),1),i[0]||(i[0]=e("br",null,null,-1)),b(" "+s(a.$gettext("Country"))+" : "+s(r.location.country),1),i[1]||(i[1]=e("br",null,null,-1)),b(" "+s(a.$gettext("Region"))+" : "+s(r.location.region),1),i[2]||(i[2]=e("br",null,null,-1)),b(" "+s(a.$gettext("City"))+" : "+s(r.location.city),1),i[3]||(i[3]=e("br",null,null,-1)),b(" "+s(a.$gettext("Time"))+" : "+s(r.connected_time),1),i[4]||(i[4]=e("br",null,null,-1)),b(" "+s(a.$gettext("User Agent"))+" : "+s(r.user_agent),1)]),_:2},1032,["position"]))),128))]),_:1})):M("",!0)}}),v=Object.freeze({All:"all",Mobile:"mobile",Desktop:"desktop",Bot:"bot"}),Te={class:"row row-cols-md-auto g-3 align-items-center"},Se={class:"col-12"},Me={for:"minLength"},we={class:"input-group input-group-sm"},Ee={class:"col-12"},Ue={for:"maxLength"},Ae={class:"input-group input-group-sm"},Re={class:"col-12"},Ie={for:"type"},Pe={class:"input-group input-group-sm"},ze=["value"],Ve=["value"],Oe=["value"],qe=["value"],Be={class:"col-12"},He=S({__name:"FiltersBar",props:{filters:{required:!0},filtersModifiers:{}},emits:["update:filters"],setup(n){const t=ce(n,"filters"),m=()=>{t.value.minLength=null,t.value.maxLength=null,t.value.type=v.All};return(a,i)=>(f(),p("div",Te,[e("div",Se,[e("label",Me,s(a.$gettext("Min. Connected Time")),1),e("div",we,[E(e("input",{id:"minLength","onUpdate:modelValue":i[0]||(i[0]=r=>t.value.minLength=r),type:"number",class:"form-control",min:"0",step:"1"},null,512),[[O,t.value.minLength]])])]),e("div",Ee,[e("label",Ue,s(a.$gettext("Max. Connected Time")),1),e("div",Ae,[E(e("input",{id:"maxLength","onUpdate:modelValue":i[1]||(i[1]=r=>t.value.maxLength=r),type:"number",class:"form-control",min:"0",step:"1"},null,512),[[O,t.value.maxLength]])])]),e("div",Re,[e("label",Ie,s(a.$gettext("Listener Type")),1),e("div",Pe,[E(e("select",{"onUpdate:modelValue":i[2]||(i[2]=r=>t.value.type=r),class:"form-select form-select-sm"},[e("option",{value:u(v).All},s(a.$gettext("All Types")),9,ze),e("option",{value:u(v).Mobile},s(a.$gettext("Mobile")),9,Ve),e("option",{value:u(v).Desktop},s(a.$gettext("Desktop")),9,Oe),e("option",{value:u(v).Bot},s(a.$gettext("Bot/Crawler")),9,qe)],512),[[de,t.value.type]])])]),e("div",Be,[e("button",{type:"button",class:"btn btn-sm btn-secondary",onClick:m},[h(C,{icon:u(fe)},null,8,["icon"]),e("span",null,s(a.$gettext("Clear Filters")),1)])])]))}}),Je={class:"row"},Ne={class:"col-sm-12"},je={class:"card"},We={class:"card-header text-bg-primary"},Ye={class:"d-lg-flex align-items-center"},Ge={class:"flex-fill my-0"},Ke={class:"card-title"},Qe={class:"flex-shrink buttons mt-2 mt-lg-0"},Xe=["href"],Ze={key:0,class:"flex-shrink buttons ms-lg-2 mt-2 mt-lg-0"},et={class:"card-body pb-0"},tt={class:"nav nav-tabs",role:"tablist"},st={class:"nav-item",role:"presentation"},lt={class:"nav-item",role:"presentation"},nt={id:"map"},ot={class:"card-body"},it={class:"row row-cols-md-auto align-items-center"},at={class:"col-12 text-start text-md-end h5"},rt={class:"col-12 h3"},ut={class:"col-12 text-start text-md-end h5"},ct={class:"col-12 h3"},dt={class:"col-12"},mt={class:"d-flex align-items-center"},ft={class:"flex-shrink-0 pe-2"},pt={key:0},_t={class:"visually-hidden"},vt={key:1},ht={class:"visually-hidden"},bt={key:2},gt={class:"visually-hidden"},yt={class:"flex-fill"},kt={key:0},Lt={class:"small"},Ft={key:0},$t={key:1},xt={key:0},Dt={key:1},Ct={key:0},Tt={key:1},St=["innerHTML"],Kt=S({__name:"Listeners",props:{attribution:{}},setup(n){const t=ye("/listeners"),m=U(!0),a=H([]),{DateTime:i}=$e(),{timezone:r}=le(),{now:g,formatTimestampAsDateTime:y}=Fe(),F=g(),W=F.minus({years:5}).toJSDate(),Y=F.plus({days:5}).toJSDate(),k=U({startDate:F.minus({days:1}).toJSDate(),endDate:F.toJSDate()}),_=U({minLength:null,maxLength:null,type:v.All}),{$gettext:d}=B(),G=[{key:"ip",label:d("IP"),sortable:!1,selectable:!0,visible:!0},{key:"connected_time",label:d("Time"),sortable:!0,formatter:(c,l,o)=>Le(o.connected_time),selectable:!0,visible:!0},{key:"connected_time_sec",label:d("Time (sec)"),sortable:!1,formatter:(c,l,o)=>o.connected_time,selectable:!0,visible:!1},{key:"connected_on",label:d("Start Time"),sortable:!0,formatter:(c,l,o)=>y(o.connected_on,i.DATETIME_SHORT),selectable:!0,visible:!1},{key:"connected_until",label:d("End Time"),sortable:!0,formatter:(c,l,o)=>y(o.connected_until,i.DATETIME_SHORT),selectable:!0,visible:!1},{key:"device.client",isRowHeader:!0,label:d("User Agent"),sortable:!0,selectable:!0,visible:!0},{key:"stream",label:d("Stream"),sortable:!0,selectable:!0,visible:!0},{key:"location",label:d("Location"),sortable:!0,sorter:c=>{var l,o,z;return((l=c.location)==null?void 0:l.country)+" "+((o=c.location)==null?void 0:o.region)+" "+((z=c.location)==null?void 0:z.city)},selectable:!0,visible:!0}],K=D(()=>{const c=new URL(t.value,document.location.href),l=c.searchParams;return l.set("format","csv"),m.value||(l.set("start",i.fromJSDate(k.value.startDate).toISO()),l.set("end",i.fromJSDate(k.value.endDate).toISO())),c.toString()}),{axios:Q}=ne(),I=A("$dataTable"),{navigate:X}=ke(I),Z=D(()=>_.value.minLength!==null||_.value.maxLength!==null||v.All!==_.value.type),w=D(()=>Z.value?j.filter(a.value,c=>{const l=c.connected_time;if(_.value.minLength!==null&&l<_.value.minLength||_.value.maxLength!==null&&l>_.value.maxLength)return!1;if(v.All!==_.value.type){if(v.Mobile===_.value.type&&!c.device.is_mobile)return!1;if(v.Desktop===_.value.type&&c.device.is_mobile)return!1}return!0}):a.value??[]),ee=D(()=>{let c=0;w.value.forEach(function(o){c+=o.connected_time});const l=c/3600;return Math.round((l+1e-5)*100)/100}),$=()=>{const c={};m.value||(c.start=i.fromJSDate(k.value.startDate).toISO(),c.end=i.fromJSDate(k.value.endDate).toISO()),Q.get(t.value,{params:c}).then(l=>{a.value=l.data,X(),m.value&&setTimeout($,document.hidden?3e4:15e3)}).catch(l=>{m.value&&(!l.response||l.response.data.code!==403)&&setTimeout($,document.hidden?12e4:3e4)})};R(k,$),J($);const P=c=>{m.value=c,me($)};return(c,l)=>(f(),p("div",Je,[e("div",Ne,[e("div",je,[e("div",We,[e("div",Ye,[e("div",Ge,[e("h2",Ke,s(u(d)("Listeners")),1)]),e("div",Qe,[e("a",{id:"btn-export",class:"btn btn-dark",href:K.value,target:"_blank"},[h(C,{icon:u(pe)},null,8,["icon"]),e("span",null,s(u(d)("Download CSV")),1)],8,Xe)]),m.value?M("",!0):(f(),p("div",Ze,[h(ge,{modelValue:k.value,"onUpdate:modelValue":l[0]||(l[0]=o=>k.value=o),options:{timezone:u(r),enableTimePicker:!0,minDate:u(W),maxDate:u(Y)},class:"btn-dark"},null,8,["modelValue","options"])]))])]),e("div",et,[e("nav",tt,[e("div",st,[e("button",{class:q(["nav-link",m.value?"active":""]),type:"button",role:"tab",onClick:l[1]||(l[1]=o=>P(!0))},s(u(d)("Live Listeners")),3)]),e("div",lt,[e("button",{class:q(["nav-link",m.value?"":"active"]),type:"button",role:"tab",onClick:l[2]||(l[2]=o=>P(!1))},s(u(d)("Listener History")),3)])])]),e("div",nt,[h(Ce,{listeners:w.value},null,8,["listeners"])]),e("div",null,[e("div",ot,[e("div",it,[e("div",at,[b(s(u(d)("Unique Listeners"))+" ",1),l[5]||(l[5]=e("br",null,null,-1)),e("small",null,s(u(d)("for selected period")),1)]),e("div",rt,s(a.value.length),1),e("div",ut,[b(s(u(d)("Total Listener Hours"))+" ",1),l[6]||(l[6]=e("br",null,null,-1)),e("small",null,s(u(d)("for selected period")),1)]),e("div",ct,s(ee.value),1),e("div",dt,[h(He,{filters:_.value,"onUpdate:filters":l[3]||(l[3]=o=>_.value=o)},null,8,["filters"])])])]),h(be,{id:"station_listeners",ref_key:"$dataTable",ref:I,paginated:"","handle-client-side":"",fields:G,items:w.value,"select-fields":"",onRefreshClicked:l[4]||(l[4]=o=>$())},{"cell(device.client)":T(o=>[e("div",mt,[e("div",ft,[o.item.device.is_bot?(f(),p("span",pt,[h(C,{icon:u(_e)},null,8,["icon"]),e("span",_t,s(u(d)("Bot/Crawler")),1)])):o.item.device.is_mobile?(f(),p("span",vt,[h(C,{icon:u(ve)},null,8,["icon"]),e("span",ht,s(u(d)("Mobile")),1)])):(f(),p("span",bt,[h(C,{icon:u(he)},null,8,["icon"]),e("span",gt,s(u(d)("Desktop")),1)]))]),e("div",yt,[o.item.device.client?(f(),p("div",kt,s(o.item.device.client),1)):M("",!0),e("div",Lt,s(o.item.user_agent),1)])])]),"cell(stream)":T(o=>[o.item.mount_name===""?(f(),p("span",Ft,s(u(d)("Unknown")),1)):(f(),p("span",$t,[b(s(o.item.mount_name),1),l[7]||(l[7]=e("br",null,null,-1)),o.item.mount_is_local?(f(),p("small",xt,s(u(d)("Local")),1)):(f(),p("small",Dt,s(u(d)("Remote")),1))]))]),"cell(location)":T(o=>[o.item.location.description?(f(),p("span",Ct,s(o.item.location.description),1)):(f(),p("span",Tt,s(u(d)("Unknown")),1))]),_:1},8,["items"])]),e("div",{class:"card-body card-padding-sm text-muted",innerHTML:c.attribution},null,8,St)])])]))}});export{Kt as default};
